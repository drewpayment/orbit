# Project Structure

**Last Updated**: 2025-01-15
**Scope**: Monorepo architecture and service organization

## Directory Overview

```
orbit-www/                    # Payload 3.0 CMS + Next.js 15 frontend
  src/
    app/                      # Next.js App Router pages
      (admin)/                # Admin routes (workspace management)
      (frontend)/             # Public-facing pages
    collections/              # Payload CMS collections
      Users.ts                # User authentication and profiles
      Media.ts                # File uploads
      Workspaces.ts           # Multi-tenant workspace management
    components/               # React components
      ui/                     # shadcn/ui components
    lib/                      # Shared utilities
      proto/                  # Generated TypeScript gRPC clients
    payload.config.ts         # Payload CMS configuration
  package.json                # Frontend dependencies (includes buf CLI)

services/                     # Go microservices (gRPC-based)
  repository/                 # Repository management service
    cmd/server/               # Main entry point
    internal/
      domain/                 # Business entities (Repository, Branch, etc.)
      service/                # Business logic implementation
      grpc/                   # gRPC server implementation
      temporal/               # Temporal activities for async operations
    go.mod                    # Module: github.com/drewpayment/orbit/services/repository

  api-catalog/                # API schema catalog service
    cmd/server/
    internal/
      domain/                 # API schema entities
      service/
      grpc/
    go.mod                    # Module: github.com/drewpayment/orbit/services/api-catalog

  knowledge/                  # Knowledge management service
    cmd/server/
    internal/
      domain/                 # Document entities
      service/
      grpc/
    go.mod                    # Module: github.com/drewpayment/orbit/services/knowledge

temporal-workflows/           # Temporal workflow definitions
  cmd/worker/                 # Temporal worker entry point
  internal/
    workflows/                # Workflow definitions (long-running operations)
    activities/               # Activity implementations
  go.mod                      # Module: github.com/drewpayment/orbit/temporal-workflows

proto/                        # Protocol buffer definitions
  workspace.proto             # Workspace service contract
  repository.proto            # Repository service contract
  api_catalog.proto           # API catalog service contract
  knowledge.proto             # Knowledge service contract
  gen/go/                     # Generated Go code (gitignored)
  go.mod                      # Module: github.com/drewpayment/orbit/proto

infrastructure/               # Deployment and infrastructure configs
  temporal/
    dynamicconfig/            # Temporal server configuration

specs/                        # Feature specifications and requirements
```

## Key Architectural Patterns

### Monorepo Module Structure
Each Go service is a separate module with shared proto module:
```go
// In each service's go.mod:
replace github.com/drewpayment/orbit/proto => ../../proto
```

### Three-Layer Architecture (Per Go Service)
1. **Domain Layer** (`internal/domain/`) - Business entities, pure Go structs, no external dependencies
2. **Service Layer** (`internal/service/`) - Business logic, orchestrates domain objects
3. **Interface Layer** (`internal/grpc/`) - gRPC server implementation, request/response translation

### Request Flow

**Frontend to Backend:**
```
Next.js Page → TypeScript gRPC Client → Go gRPC Service → Domain Logic → Database
```

**Service to Service:**
```
Service A → gRPC Call → Service B → Response
```

**Long-Running Operations:**
```
Frontend → Temporal Workflow Start → Activities → Progress Tracking → Completion
```

## Critical Files & Directories

### DO NOT MODIFY Without Review
- `proto/*.proto` - Requires `make proto-gen` after changes
- `orbit-www/src/payload.config.ts` - Core CMS configuration
- `temporal-workflows/internal/workflows/` - Workflow changes must be backward compatible

### Frequently Modified
- `orbit-www/src/collections/` - Add/modify Payload collections here
- `services/*/internal/grpc/` - gRPC endpoint implementations
- `services/*/internal/service/` - Business logic lives here

### Generated (Never Edit Directly)
- `proto/gen/go/` - Regenerated by `make proto-gen`
- `orbit-www/src/lib/proto/` - Regenerated by `make proto-gen`

## Module Dependencies

### Frontend Dependencies
```
orbit-www → proto (generated TypeScript clients)
```

### Service Dependencies
```
repository-service → proto (generated Go server/client)
api-catalog-service → proto
knowledge-service → proto
temporal-workflows → proto (for service clients)
```

### Dependency Rules
- **Domain layer**: NO external dependencies (pure Go)
- **Service layer**: Can depend on domain + proto + third-party libs
- **gRPC layer**: Can depend on service + proto
- **Temporal layer**: Can depend on service + domain + proto

## Code Organization Conventions

### Go Services Structure
```
cmd/server/
  main.go              # Entry point, wire up dependencies

internal/
  domain/
    repository.go      # Entity: type Repository struct { ... }
    errors.go          # Domain errors

  service/
    repository_service.go    # Business logic implementation
    repository_service_test.go

  grpc/
    server.go          # gRPC server setup
    repository_handler.go    # gRPC method handlers

  temporal/
    activities.go      # Temporal activity definitions
```

### Frontend Structure
```
app/
  (admin)/             # Admin UI routes (authentication required)
    workspaces/        # Workspace management
  (frontend)/          # Public routes
  layout.tsx           # Root layout

collections/
  Workspaces.ts        # Payload collection definition

components/
  ui/                  # shadcn/ui primitives
  forms/               # Form components
  layouts/             # Layout components
```

## Service Startup Order

1. **Infrastructure**: `make dev` starts PostgreSQL, Redis, Temporal, MinIO
2. **Frontend**: `cd orbit-www && pnpm dev` (port 3000)
3. **Go Services**: Start individually or via Docker Compose
4. **Temporal Worker**: Start last to pick up workflows

## Testing Organization

```
services/*/internal/
  service/
    *_test.go          # Unit tests (table-driven)
  grpc/
    *_test.go          # gRPC handler tests

orbit-www/
  src/
    components/
      **/*.test.tsx    # Vitest component tests
  tests/
    e2e/               # Playwright E2E tests
```

## Common Patterns

### Adding a New Go Service
1. Create `services/[name]/` directory
2. Initialize module: `cd services/[name] && go mod init github.com/drewpayment/orbit/services/[name]`
3. Add proto replace: `go mod edit -replace github.com/drewpayment/orbit/proto=../../proto`
4. Follow standard layout: `cmd/server/`, `internal/{domain,service,grpc}`
5. Update `Makefile` targets
6. Add service to `docker-compose.yml`

### Adding a New Protobuf Service
1. Create `proto/[service].proto`
2. Run `make proto-gen`
3. Implement server in `services/[service]/internal/grpc/`
4. Use generated client in frontend from `orbit-www/src/lib/proto/`

## Related Documentation
- See: [api-architecture.md](api-architecture.md) for gRPC details
- See: [database-schema.md](database-schema.md) for data models
- See: [../SOPs/adding-grpc-services.md](../SOPs/adding-grpc-services.md) for step-by-step service creation
