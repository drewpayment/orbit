apiVersion: apps/v1
kind: Deployment
metadata:
  name: orbit-www
  namespace: orbit-www
  labels:
    app.kubernetes.io/name: orbit-www
    app.kubernetes.io/component: frontend
spec:
  replicas: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: orbit-www
      app.kubernetes.io/component: frontend
  template:
    metadata:
      labels:
        app.kubernetes.io/name: orbit-www
        app.kubernetes.io/component: frontend
        app.kubernetes.io/part-of: orbit
    spec:
      serviceAccountName: orbit-www
      containers:
        - name: orbit-www
          image: ghcr.io/drewpayment/orbit/orbit-www:latest
          ports:
            - containerPort: 3000
              name: http
          env:
            # Database
            - name: DATABASE_URI
              valueFrom:
                secretKeyRef:
                  name: orbit-www-secrets
                  key: database_uri
            # Payload CMS
            - name: PAYLOAD_SECRET
              valueFrom:
                secretKeyRef:
                  name: orbit-www-secrets
                  key: payload_secret
            # Temporal
            - name: TEMPORAL_NAMESPACE
              value: default
            - name: TEMPORAL_ADDRESS
              value: temporal-server.orbit-temporal.svc.cluster.local:7233
            # Repository Service
            - name: NEXT_PUBLIC_REPOSITORY_URL
              value: http://repository-service.orbit-repository-service.svc.cluster.local:50051
            - name: REPOSITORY_SERVICE_URL
              value: http://repository-service.orbit-repository-service.svc.cluster.local:50051
            # GitHub App
            - name: GITHUB_APP_ID
              valueFrom:
                secretKeyRef:
                  name: orbit-www-secrets
                  key: github_app_id
            - name: GITHUB_APP_PRIVATE_KEY
              valueFrom:
                secretKeyRef:
                  name: orbit-www-secrets
                  key: github_app_private_key
            - name: GITHUB_CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: orbit-www-secrets
                  key: github_client_id
            - name: GITHUB_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: orbit-www-secrets
                  key: github_client_secret
            - name: GITHUB_WEBHOOK_SECRET
              valueFrom:
                secretKeyRef:
                  name: orbit-www-secrets
                  key: github_webhook_secret
            # Internal API Key
            - name: ORBIT_INTERNAL_API_KEY
              valueFrom:
                secretKeyRef:
                  name: orbit-www-secrets
                  key: orbit_internal_api_key
            # Redis
            - name: REDIS_URL
              value: redis://:$(REDIS_PASSWORD)@redis.orbit-redis.svc.cluster.local:6379
            # App Config
            - name: NODE_ENV
              value: production
            - name: NEXT_TELEMETRY_DISABLED
              value: "1"
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "1Gi"
              cpu: "1000m"
          livenessProbe:
            httpGet:
              path: /api/health
              port: 3000
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /api/health
              port: 3000
            initialDelaySeconds: 10
            periodSeconds: 5
      nodeSelector:
        kubernetes.io/os: linux
