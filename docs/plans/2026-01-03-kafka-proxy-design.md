Product Specification: Enterprise Kafka Gateway (Project "Bifrost")Version: 1.0.0Status: DRAFTTarget Audience: Platform Engineering, Core Infrastructure Team1. Executive SummaryThis document defines the technical specifications for a custom Enterprise Kafka Gateway. The objective is to build a protocol-aware proxy that virtualizes the Kafka interface, decoupling application teams (tenants) from the underlying physical infrastructure. This enables the platform team to perform critical operations—such as cluster migration, encryption at-rest, and strict governance enforcement—without requiring changes to client application code or configuration.2. System Architecture2.1 Architectural Pattern: Layer 7 Protocol ProxyThe system will operate as a Layer 7 (Application Layer) Proxy capable of decoding, inspecting, and mutating the Kafka Wire Protocol. Unlike a Layer 4 Load Balancer (TCP), the Gateway must understand Kafka primitives (Metadata, Produce, Fetch, Coordinator) to perform virtualization.Foundation Framework: Kroxylicious (Java/Netty).Rationale: Leverage the existing Java ecosystem for Kafka (Serdes, Schema Registry clients, KMS SDKs) and the Netty event loop for high-throughput non-blocking I/O.1Deployment Model: Centralized Gateway Cluster (not sidecar).The Gateway will sit behind a standard Network Load Balancer (NLB).It will be stateless, allowing horizontal scaling based on CPU/Memory usage.2.2 Core ComponentsVirtualization Engine: Maps incoming client connections on specific ports/SNI hostnames to "Virtual Clusters."Filter Chain: A pipeline of interceptors (Netty handlers) that process requests/responses.State Manager (Stateless/Ephemeral): Manages ephemeral state like correlation ID mappings and cached Data Encryption Keys (DEKs).Control Plane: An Operator/Controller that watches GitOps repositories (or Kubernetes CRDs) to hot-reload configurations.3. Functional Specifications3.1 Feature Set: Multi-Tenancy & VirtualizationGoal: Tenants must believe they own the cluster. No name collisions allowed.Requirement IDFeatureSpecificationTech Implementation NotesF-VIRT-01Virtual ClustersThe system must expose unique entry points (e.g., port 9093 for Tenant A, 9094 for Tenant B) that map to a shared physical cluster.Intercept MetadataRequest. Rewrite advertised.listeners in the response to point back to the Gateway's public address.1F-VIRT-02Topic VirtualizationThe system must transparently prefix topics to prevent collisions. Tenant sees orders; Physical Broker sees tenantA-orders.Inbound: Intercept CreateTopics, Produce, Fetch, Metadata. Prepend tenant_prefix.Outbound: Intercept MetadataResponse. Filter topics not matching prefix. Strip prefix before returning to client.F-VIRT-03Group VirtualizationThe system must virtualize group.id to prevent consumer group collisions.Intercept FindCoordinator, JoinGroup, SyncGroup. Prepend tenant_prefix to group.id.F-VIRT-04Transactional IsolationThe system must virtualize transactional.id to allow idempotent producers with same IDs in different tenants.Intercept InitProducerId, AddPartitionsToTxn. Prepend prefix. Handle transactional.id expiration logic if necessary.3.2 Feature Set: Governance & Schema EnforcementGoal: "Garbage In, Error Out." Stop bad data before it hits the disk.Requirement IDFeatureSpecificationTech Implementation NotesF-GOV-01Schema ValidationThe system must validate Produce payloads against a Schema Registry before forwarding to the broker.Filter Logic:1. Decode ProduceRequest.2. Extract Schema ID (Magic Byte + 4 bytes).3. Verify ID exists in Registry (Cache results).4. (Optional) Deep validation of payload bytes against schema structure.3F-GOV-02Quotas & ThrottlingThe system must enforce throughput limits per Virtual Cluster, independent of broker quotas.Implement Token Bucket rate limiter in the proxy. If limit exceeded, use Traffic Shaping (artificial latency) rather than immediate disconnect to backpressure TCP.53.3 Feature Set: Data Security (Encryption)Goal: Zero-knowledge broker infrastructure.Requirement IDFeatureSpecificationTech Implementation NotesF-SEC-01Envelope EncryptionThe system must encrypt message values using a unique Data Encryption Key (DEK) per topic/tenant.Workflow:1. Generate DEK via KMS (Vault/AWS KMS).2. Encrypt payload.3. Wrap DEK with Key Encryption Key (KEK).4. Store `` in the record value.1F-SEC-02DEK CachingThe system must cache DEKs to minimize KMS latency.Cache DEK for N minutes or M messages. Rotate automatically. Critical: Do not log DEKs.73.4 Feature Set: Zero-Downtime MigrationGoal: Move tenants between clusters without restarting their apps.Requirement IDFeatureSpecificationTech Implementation NotesF-MIG-01Dual Write (Shadowing)The system should support duplicating Produce traffic to a secondary cluster asynchronously.Filter copies ProduceRequest to Target Cluster. Failure in shadow write must not fail the primary request (Best Effort).8F-MIG-02Offset TranslationThe system must translate offsets between Source and Target clusters during a switchover.Complex Logic:Maintain an offset delta map: VirtualOffset = PhysicalOffset + Delta.Intercept FetchRequest/FetchResponse and adjust offsets in real-time based on the mapping context.4. API & Configuration SpecificationsThe Gateway will be configured declaratively ("GitOps"). We will define a Kubernetes Custom Resource Definition (CRD) or a standard YAML config format.4.1 Sample Configuration Object (KafkaVirtualCluster)YAMLapiVersion: gateway.corp/v1alpha1
kind: KafkaVirtualCluster
metadata:
  name: tenant-a-prod
spec:
  # 1. Virtualization Interface
  listener:
    bind: 0.0.0.0
    port: 9093
    advertisedHost: gateway.corp.net

  # 2. Backing Infrastructure
  targetCluster:
    bootstrapServers: "broker-1.internal:9092,broker-2.internal:9092"
  
  # 3. Isolation Rules
  virtualization:
    topicPrefix: "t1-"
    groupPrefix: "t1-"
    transactionIdPrefix: "t1-"

  # 4. Active Filters (The Chain)
  filters:
    - name: SchemaValidator
      config:
        registryUrl: "http://schema-registry.internal:8081"
        enforce: true
    - name: EnvelopeEncryption
      config:
        kmsProvider: "Vault"
        keyId: "tenant-a-master-key"
        cacheExpirySeconds: 300
5. Non-Functional Requirements (NFRs)5.1 Performance CriteriaLatency Overhead:Plaintext/Passthrough: < 2ms p99 added latency.With Encryption/Validation: < 10ms p99 added latency.9Throughput: Must support linear horizontal scaling. Adding replicas should linearly increase total supported throughput (MB/s).5.2 ReliabilityStatelessness: No local disk state. All configuration must come from the Control Plane/ConfigMap.Connection Draining: Support SIGTERM for graceful shutdown, allowing in-flight requests to complete before closing sockets.5.3 CompatibilityKafka Protocol: Support Kafka Protocol versions 2.8 through 3.8+ (Flexible versioning headers).Client Libraries: Must accept connections from librdkafka (C++, Python, Go) and kafka-clients (Java).6. Acceptance Criteria (AC)AC 1: Transparent ConnectivityScenario: A client connects to the Gateway port 9093.Verify: Client successfully receives metadata. Client producers can send messages. Client consumers can read messages.Verify: Broker logs show connections originating only from Gateway IP.AC 2: Tenant IsolationScenario: Tenant A creates topic orders. Tenant B creates topic orders.Verify: Physical broker contains tenantA-orders and tenantB-orders. Data does not cross-contaminate.AC 3: Governance EnforcementScenario: Producer sends a message with an invalid schema ID (or no schema ID) to a validated topic.Verify: Gateway returns a POLICY_VIOLATION or CORRUPT_MESSAGE error code to the client. The message does not reach the broker.3AC 4: Chaos ResilienceScenario: Introduce 500ms network lag between Gateway and Broker using Chaos Mesh.Verify: Gateway exerts backpressure (TCP window size reduction) on the client rather than buffering infinitely and crashing (OOM).117. Implementation RoadmapPhase 1 (MVP): "The Pipe". Basic protocol proxying with Metadata rewriting. No filters.Phase 2 (Multi-Tenancy): Implement Topic and Group ID rewriting filters.Phase 3 (Security): Integration with KMS and implementation of Envelope Encryption.Phase 4 (Advanced Ops): Migration logic (Dual Write & Offset Translation).