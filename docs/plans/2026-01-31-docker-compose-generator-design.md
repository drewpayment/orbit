# Docker Compose Generator Design

**Date**: 2026-01-31  
**Status**: Design Complete  
**Authors**: Drew + Claude

---

## Overview

A Docker Compose generator that creates deployment files from an Orbit application's configuration and commits them (or opens a PR) to the app's GitHub repository.

This is the first deployment generator implementation, establishing patterns for Helm and Terraform generators to follow.

## User Flow

1. User navigates to App detail page → clicks "Add Deployment"
2. Modal shows minimal fields:
   - Deployment name (e.g., "local-dev")
   - Service name (auto-filled from app name)
   - Port (auto-filled from app config or default 3000)
   - Image source toggle
   - **Delivery method**: "Open PR" (default) or "Commit directly"
3. Optional: User expands "Advanced" for replicas, resources, volumes, etc.
4. User clicks "Generate"
5. Temporal workflow executes:
   - Fetches app config (registry, env vars)
   - Renders templates
   - Commits to repo or opens PR via GitHub App
6. UI shows success panel with:
   - Link to PR/commit
   - Copy-paste commands to run locally
   - List of generated files

## Configuration Fields

### Minimal (always visible)
- Service name (auto-filled from app name)
- Port (default from app config or 3000)
- Image source (dropdown: "Use app's registry" or "Custom image")
- Delivery method ("Open PR" or "Commit directly")

### Advanced (toggle to reveal)
- Replica count
- Resource limits (CPU/memory)
- Volume mounts
- Network mode
- Health check config
- Additional services (e.g., database sidecars)
- Custom environment variables (beyond what's in Orbit)

### Auto-inferred (no user input)
- Image registry/name/tag — pulled from app's `RegistryConfig`
- Environment variables — pulled from app's `EnvironmentVariables` collection
- Labels — auto-generated for Orbit tracking

## Generated Files

```
deploy/
├── docker-compose.yml    # Service definition, references ${VARS}
├── .env.example          # Required vars with placeholder values
└── README.md             # Quick start instructions
```

### docker-compose.yml

```yaml
version: "3.8"

services:
  {{.ServiceName}}:
    image: {{.Image}}
    ports:
      - "{{.HostPort}}:{{.ContainerPort}}"
    env_file:
      - .env
    {{- if .Replicas}}
    deploy:
      replicas: {{.Replicas}}
    {{- end}}
    {{- if or .CPULimit .MemoryLimit}}
    deploy:
      resources:
        limits:
          {{- if .CPULimit}}
          cpus: "{{.CPULimit}}"
          {{- end}}
          {{- if .MemoryLimit}}
          memory: {{.MemoryLimit}}
          {{- end}}
    {{- end}}
    {{- if .HealthCheck}}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:{{.ContainerPort}}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    {{- end}}
    restart: unless-stopped
```

### .env.example

```bash
# Generated by Orbit - copy to .env and fill in values
{{range .EnvVars}}
{{.Key}}={{if .IsSecret}}# <secret - get from Orbit>{{else}}{{.Value}}{{end}}
{{end}}
```

### README.md

```markdown
# {{.AppName}} - Local Development

Generated by [Orbit]({{.OrbitURL}}) on {{.GeneratedAt}}

## Quick Start

1. Copy environment file:
   ```bash
   cp .env.example .env
   ```

2. Fill in secret values in `.env`

3. Run:
   ```bash
   docker-compose up -d
   ```

## Services

- **{{.ServiceName}}**: http://localhost:{{.HostPort}}
```

## Secret Handling

Environment variables in Orbit can contain secrets (encrypted at rest). Generated files handle this safely:

- `docker-compose.yml` references variables via `env_file: .env`
- `.env.example` is committed with placeholder comments for secrets
- `.env` is gitignored — user creates locally from example
- Secret values never appear in committed files

## Technical Architecture

### Components

| Layer | Component | Responsibility |
|-------|-----------|----------------|
| UI | `AddDeploymentModal` | Collect user input, show progress |
| Server Action | `deployments.ts` | Validate input, trigger workflow |
| Temporal Workflow | `DeploymentWorkflow` | Orchestrate generation steps |
| Temporal Activity | `ExecuteGenerator` | Render templates, call GitHub API |
| GitHub App | (existing) | Commit files or create PR |

### Data Flow

```
User Input → Server Action → Temporal Workflow
                                   ↓
                            1. FetchAppConfig (get registry, env vars)
                                   ↓
                            2. FetchGenerator (get templates from DB)
                                   ↓
                            3. RenderTemplates (Go text/template)
                                   ↓
                            4. CommitToRepo or CreatePR (GitHub API)
                                   ↓
                            5. UpdateDeploymentStatus (success + file list)
                                   ↓
UI polls/subscribes ←────── Deployment record updated
```

### Existing Infrastructure

- `DeploymentWorkflow` and `DeploymentActivities` — scaffolded in `temporal-workflows/`
- `AddDeploymentModal` — functional, needs enhancements
- `DeploymentGenerators` collection — ready for seed data
- GitHub App integration — used by template instantiation, can reuse

## Implementation Tasks

### Phase 1: Backend (Temporal Activities) — 2-3 days

1. **Implement `RenderTemplates` logic** in `deployment_activities.go`
   - Load generator from Payload by slug
   - Fetch app's registry config + environment variables
   - Execute Go `text/template` against template files

2. **Implement `CommitToRepo` / `CreatePR` activity**
   - Reuse existing GitHub App client from template instantiation
   - Support both direct commit and PR creation modes

3. **Seed built-in generator record**
   - Create "docker-compose-basic" generator with templates above

### Phase 2: Frontend — 2-3 days

1. **Update `AddDeploymentModal`**
   - Add delivery method toggle (PR vs direct commit)
   - Add "Advanced" collapsible section
   - Add advanced fields (replicas, resources, health check, volumes)

2. **Create `DeploymentSuccessPanel` component**
   - Shows generated file list with links
   - Copy-paste terminal commands
   - Link to PR/commit on GitHub

### Phase 3: Polish — 1-2 days

1. **Error handling** — surface GitHub API errors clearly
2. **Validation** — ensure app has registry configured before allowing generation
3. **Tests** — unit tests for template rendering, integration test for full flow

## Estimated Effort

~1 week total

## Future Considerations

- **Helm generator**: Similar pattern, but with `values.yaml` and chart structure
- **Terraform generator**: Adds state management, provider configuration
- **Orbit CLI**: Could add `orbit secrets pull` command for local dev convenience
