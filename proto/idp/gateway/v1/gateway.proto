// proto/idp/gateway/v1/gateway.proto
syntax = "proto3";

package idp.gateway.v1;

option go_package = "github.com/drewpayment/orbit/proto/gen/go/idp/gateway/v1;gatewayv1";
option java_package = "idp.gateway.v1";
option java_outer_classname = "Gateway";
option java_multiple_files = false;

import "google/protobuf/timestamp.proto";

// ============================================================================
// Bifrost Admin Service (Control Plane → Gateway)
// ============================================================================

service BifrostAdminService {
  // Virtual Cluster lifecycle
  rpc UpsertVirtualCluster(UpsertVirtualClusterRequest) returns (UpsertVirtualClusterResponse);
  rpc DeleteVirtualCluster(DeleteVirtualClusterRequest) returns (DeleteVirtualClusterResponse);
  rpc SetVirtualClusterReadOnly(SetVirtualClusterReadOnlyRequest) returns (SetVirtualClusterReadOnlyResponse);

  // Credential management
  rpc UpsertCredential(UpsertCredentialRequest) returns (UpsertCredentialResponse);
  rpc RevokeCredential(RevokeCredentialRequest) returns (RevokeCredentialResponse);
  rpc ListCredentials(ListCredentialsRequest) returns (ListCredentialsResponse);

  // Full sync (startup reconciliation)
  rpc GetFullConfig(GetFullConfigRequest) returns (GetFullConfigResponse);

  // Health & observability
  rpc GetStatus(GetStatusRequest) returns (GetStatusResponse);
  rpc ListVirtualClusters(ListVirtualClustersRequest) returns (ListVirtualClustersResponse);

  // Policy management
  rpc UpsertPolicy(UpsertPolicyRequest) returns (UpsertPolicyResponse);
  rpc DeletePolicy(DeletePolicyRequest) returns (DeletePolicyResponse);
  rpc ListPolicies(ListPoliciesRequest) returns (ListPoliciesResponse);
}

// ============================================================================
// Messages: Virtual Clusters
// ============================================================================

message VirtualClusterConfig {
  string id = 1;
  string application_id = 2;
  string application_slug = 3;
  string workspace_slug = 4;
  string environment = 5;
  string topic_prefix = 6;
  string group_prefix = 7;
  string transaction_id_prefix = 8;
  string advertised_host = 9;
  int32 advertised_port = 10;
  string physical_bootstrap_servers = 11;
  bool read_only = 12;
}

message UpsertVirtualClusterRequest {
  VirtualClusterConfig config = 1;
}

message UpsertVirtualClusterResponse {
  bool success = 1;
}

message DeleteVirtualClusterRequest {
  string virtual_cluster_id = 1;
}

message DeleteVirtualClusterResponse {
  bool success = 1;
}

message SetVirtualClusterReadOnlyRequest {
  string virtual_cluster_id = 1;
  bool read_only = 2;
}

message SetVirtualClusterReadOnlyResponse {
  bool success = 1;
}

// ============================================================================
// Messages: Full Config Sync
// ============================================================================

message GetFullConfigRequest {}

message GetFullConfigResponse {
  repeated VirtualClusterConfig virtual_clusters = 1;
  repeated CredentialConfig credentials = 2;
  repeated PolicyConfig policies = 3;
}

// ============================================================================
// Messages: Status
// ============================================================================

message GetStatusRequest {}

message GetStatusResponse {
  string status = 1;
  int32 active_connections = 2;
  int32 virtual_cluster_count = 3;
  map<string, string> version_info = 4;
}

message ListVirtualClustersRequest {}

message ListVirtualClustersResponse {
  repeated VirtualClusterConfig virtual_clusters = 1;
}

// ============================================================================
// Messages: Credentials
// ============================================================================

enum PermissionTemplate {
  PERMISSION_TEMPLATE_UNSPECIFIED = 0;
  PERMISSION_TEMPLATE_PRODUCER = 1;
  PERMISSION_TEMPLATE_CONSUMER = 2;
  PERMISSION_TEMPLATE_ADMIN = 3;
  PERMISSION_TEMPLATE_CUSTOM = 4;
}

message CustomPermission {
  string resource_type = 1;    // topic, group, transactional_id
  string resource_pattern = 2; // regex or literal
  repeated string operations = 3; // read, write, create, delete, alter
}

message CredentialConfig {
  string id = 1;
  string virtual_cluster_id = 2;
  string username = 3;
  string password_hash = 4;
  PermissionTemplate template = 5;
  repeated CustomPermission custom_permissions = 6;
}

message UpsertCredentialRequest {
  CredentialConfig config = 1;
}

message UpsertCredentialResponse {
  bool success = 1;
}

message RevokeCredentialRequest {
  string credential_id = 1;
}

message RevokeCredentialResponse {
  bool success = 1;
}

message ListCredentialsRequest {
  string virtual_cluster_id = 1; // Optional filter
}

message ListCredentialsResponse {
  repeated CredentialConfig credentials = 1;
}

// ============================================================================
// Messages: Policies
// ============================================================================

message PolicyConfig {
  string id = 1;
  string environment = 2;  // dev, staging, prod
  int32 max_partitions = 3;
  int32 min_partitions = 4;
  int64 max_retention_ms = 5;
  int32 min_replication_factor = 6;
  repeated string allowed_cleanup_policies = 7;
  string naming_pattern = 8;  // regex for valid topic names
  int32 max_name_length = 9;
}

message UpsertPolicyRequest {
  PolicyConfig config = 1;
}

message UpsertPolicyResponse {
  bool success = 1;
}

message DeletePolicyRequest {
  string policy_id = 1;
}

message DeletePolicyResponse {
  bool success = 1;
}

message ListPoliciesRequest {
  string environment = 1;  // Optional filter
}

message ListPoliciesResponse {
  repeated PolicyConfig policies = 1;
}

// ============================================================================
// Bifrost Callback Service (Gateway → Control Plane)
// ============================================================================

service BifrostCallbackService {
  // Topic sync (passthrough creates)
  rpc TopicCreated(TopicCreatedRequest) returns (TopicCreatedResponse);
  rpc TopicDeleted(TopicDeletedRequest) returns (TopicDeletedResponse);
  rpc TopicConfigUpdated(TopicConfigUpdatedRequest) returns (TopicConfigUpdatedResponse);
}

message TopicCreatedRequest {
  string virtual_cluster_id = 1;
  string virtual_name = 2;      // Topic name as client sees it
  string physical_name = 3;     // Full prefixed name on broker
  int32 partitions = 4;
  int32 replication_factor = 5;
  map<string, string> config = 6;
  string created_by_credential_id = 7;
}

message TopicCreatedResponse {
  bool success = 1;
  string topic_id = 2;  // Orbit's topic record ID
}

message TopicDeletedRequest {
  string virtual_cluster_id = 1;
  string virtual_name = 2;
  string physical_name = 3;
  string deleted_by_credential_id = 4;
}

message TopicDeletedResponse {
  bool success = 1;
}

message TopicConfigUpdatedRequest {
  string virtual_cluster_id = 1;
  string virtual_name = 2;
  map<string, string> config = 3;
  string updated_by_credential_id = 4;
}

message TopicConfigUpdatedResponse {
  bool success = 1;
}

// ============================================================================
// Policy Violation Details
// ============================================================================

message PolicyViolation {
  string field = 1;           // e.g., "partitions", "retention.ms"
  string constraint = 2;      // e.g., "max_partitions"
  string message = 3;         // Human-readable error
  string actual_value = 4;
  string allowed_value = 5;
}
