// proto/idp/build/v1/build.proto
syntax = "proto3";

package idp.build.v1;

option go_package = "github.com/drewpayment/orbit/proto/gen/go/idp/build/v1;buildv1";

// BuildService handles container image building via Railpack
service BuildService {
  // Analyze a repository to detect build configuration
  rpc AnalyzeRepository(AnalyzeRepositoryRequest) returns (AnalyzeRepositoryResponse);

  // Build and push a container image
  rpc BuildImage(BuildImageRequest) returns (BuildImageResponse);

  // Stream build logs in real-time
  rpc StreamBuildLogs(StreamBuildLogsRequest) returns (stream StreamBuildLogsResponse);

  // Start a build workflow via Temporal
  rpc StartBuildWorkflow(StartBuildWorkflowRequest) returns (StartBuildWorkflowResponse);

  // Get the progress of a build workflow
  rpc GetBuildProgress(GetBuildProgressRequest) returns (GetBuildProgressResponse);
}

// AnalyzeRepositoryRequest contains parameters for repository analysis
message AnalyzeRepositoryRequest {
  string repo_url = 1;           // e.g., https://github.com/org/repo
  string ref = 2;                // Branch, tag, or commit SHA
  string installation_token = 3; // GitHub App installation token for private repos
}

// AnalyzeRepositoryResponse contains the analysis results
message AnalyzeRepositoryResponse {
  bool detected = 1;                    // Whether Railpack could detect the project
  DetectedBuildConfig config = 2;       // Detected configuration (if detected=true)
  string error = 3;                     // Error message (if detected=false)
  repeated string detected_files = 4;   // Files that triggered detection
}

// DetectedBuildConfig contains Railpack-detected build settings
message DetectedBuildConfig {
  string language = 1;           // e.g., "nodejs", "python", "go"
  string language_version = 2;   // e.g., "22", "3.12", "1.22"
  string framework = 3;          // e.g., "nextjs", "fastapi", "gin"
  string build_command = 4;      // e.g., "npm run build"
  string start_command = 5;      // e.g., "npm start"
  PackageManagerInfo package_manager = 6;  // Detected package manager info
}

// Package manager detection result
message PackageManagerInfo {
  bool detected = 1;             // true if lockfile or packageManager field found
  string name = 2;               // "npm", "yarn", "pnpm", "bun", or ""
  string source = 3;             // "lockfile", "packageManager", "engines", ""
  string lockfile = 4;           // e.g., "yarn.lock" if detected from lockfile
  string requested_version = 5;  // e.g., "10.2.0" from packageManager field
  bool version_supported = 6;    // true if we can fulfill this version
  string supported_range = 7;    // e.g., ">=7.0.0" - what we support
}

// BuildImageRequest contains parameters for building an image
message BuildImageRequest {
  string request_id = 1;              // Unique request identifier
  string app_id = 2;                  // Orbit App ID
  string repo_url = 3;                // Repository URL
  string ref = 4;                     // Branch, tag, or commit SHA
  string installation_token = 5;      // GitHub App installation token

  // Build configuration (can override detected values)
  optional string language_version = 6;
  optional string build_command = 7;
  optional string start_command = 8;
  map<string, string> build_env = 9;  // Environment variables for build

  // Registry configuration
  RegistryConfig registry = 10;
  string image_tag = 11;              // Tag for the built image
  string package_manager = 12;        // "npm", "yarn", "pnpm", "bun", or "" for auto
}

// RegistryConfig contains container registry authentication
message RegistryConfig {
  RegistryType type = 1;
  string url = 2;                     // Registry URL (e.g., ghcr.io, myregistry.azurecr.io)
  string repository = 3;              // Image repository path (e.g., org/app-name)
  string token = 4;                   // Auth token (installation token for GHCR, ACR token for ACR)
  optional string username = 5;       // Username (for ACR)
}

// RegistryType enum
enum RegistryType {
  REGISTRY_TYPE_UNSPECIFIED = 0;
  REGISTRY_TYPE_GHCR = 1;
  REGISTRY_TYPE_ACR = 2;
}

// BuildImageResponse contains the build results
message BuildImageResponse {
  bool success = 1;
  string image_url = 2;               // Full image URL (e.g., ghcr.io/org/app:tag)
  string image_digest = 3;            // Image digest (sha256:...)
  string error = 4;                   // Error message if failed
  repeated BuildStep steps = 5;       // Build steps for progress tracking
}

// BuildStep represents a step in the build process
message BuildStep {
  string name = 1;
  BuildStepStatus status = 2;
  string message = 3;
  int64 duration_ms = 4;
}

// BuildStepStatus enum
enum BuildStepStatus {
  BUILD_STEP_STATUS_UNSPECIFIED = 0;
  BUILD_STEP_STATUS_PENDING = 1;
  BUILD_STEP_STATUS_RUNNING = 2;
  BUILD_STEP_STATUS_COMPLETED = 3;
  BUILD_STEP_STATUS_FAILED = 4;
}

// StreamBuildLogsRequest for streaming build output
message StreamBuildLogsRequest {
  string request_id = 1;
}

// StreamBuildLogsResponse represents a single log line
message StreamBuildLogsResponse {
  int64 timestamp = 1;
  string level = 2;                   // "info", "warn", "error"
  string message = 3;
  string step = 4;                    // Which build step this belongs to
}

// StartBuildWorkflowRequest initiates a Temporal build workflow
message StartBuildWorkflowRequest {
  string app_id = 1;                  // Orbit App ID
  string workspace_id = 2;            // Workspace ID for auth
  string user_id = 3;                 // User initiating the build
  string repo_url = 4;                // Repository URL
  string ref = 5;                     // Branch, tag, or commit SHA (default: main)
  RegistryConfig registry = 6;        // Registry configuration

  // Optional build overrides
  optional string language_version = 7;
  optional string build_command = 8;
  optional string start_command = 9;
  map<string, string> build_env = 10;
  string image_tag = 11;              // Tag for the built image
}

// StartBuildWorkflowResponse contains the workflow ID
message StartBuildWorkflowResponse {
  bool success = 1;
  string workflow_id = 2;             // Temporal workflow ID for tracking
  string error = 3;                   // Error message if failed
}

// GetBuildProgressRequest queries a build workflow's progress
message GetBuildProgressRequest {
  string workflow_id = 1;             // Temporal workflow ID
}

// GetBuildProgressResponse contains the current build progress
message GetBuildProgressResponse {
  string current_step = 1;            // e.g., "analyzing", "building", "pushing"
  int32 steps_total = 2;              // Total number of steps
  int32 steps_current = 3;            // Current step number
  string message = 4;                 // Human-readable progress message
  string status = 5;                  // "pending", "running", "success", "failed"
  string image_url = 6;               // Resulting image URL (if success)
  string image_digest = 7;            // Resulting image digest (if success)
  string error = 8;                   // Error message (if failed)
  DetectedBuildConfig detected_config = 9; // Detected build configuration
}
